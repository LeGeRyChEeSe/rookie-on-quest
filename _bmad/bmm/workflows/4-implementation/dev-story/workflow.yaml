name: dev-story
description: "Execute a story by implementing tasks/subtasks, writing tests, validating, and updating the story file per acceptance criteria"
author: "BMad"

# CRITICAL PRE-CHECK - Must execute BEFORE any workflow logic
preconditions:
  - name: "worktree-require"
    description: "Require being in correct story worktree - block if not"
    critical: true
    check: |
      1. Check if .story-id file exists in current working directory
      2. If NOT exists:
         - BLOCK with error message explaining BMad Method requirement
         - Instruct user to run create-story workflow first
      3. If exists, read .story-id content
      4. Verify worktree story matches target story
      5. If mismatch, BLOCK with error and instructions to fix
    failure_action: "HALT - Cannot continue without correct worktree"
    error_message: |
      ‚ùå NOT IN A WORKTREE - CODING BLOCKED

      BMad Method Requirement: ALL story development MUST happen in dedicated worktrees.

      To Fix:
      1. Run create-story workflow first: /bmad:bmm:workflows:create-story {story_key}
      2. Then run dev-story from within that worktree: cd worktrees/story-{story_key}

# Critical variables from config
config_source: "{project-root}/_bmad/bmm/config.yaml"
output_folder: "{config_source}:output_folder"
user_name: "{config_source}:user_name"
communication_language: "{config_source}:communication_language"
user_skill_level: "{config_source}:user_skill_level"
document_output_language: "{config_source}:document_output_language"
story_dir: "{config_source}:implementation_artifacts"
date: system-generated

# Workflow components
installed_path: "{project-root}/_bmad/bmm/workflows/4-implementation/dev-story"
instructions: "{installed_path}/instructions.xml"
validation: "{installed_path}/checklist.md"

story_file: "" # Explicit story path; auto-discovered if empty
implementation_artifacts: "{config_source}:implementation_artifacts"
sprint_status: "{implementation_artifacts}/sprint-status.yaml"
project_context: "**/project-context.md"

standalone: true
